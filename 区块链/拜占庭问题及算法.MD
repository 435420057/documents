#【区块链】拜占庭问题及算法

## 一、什么是拜占庭将军问题？

拜占庭将军问题（Byzantine Generals' Problem）是在10世纪80年代提出的一个假想问题。当时拜占庭是东罗马帝国的首都，罗马帝国物资富饶，兵强马壮，但每支军队的驻地分隔很远，将军们只能靠信使来传递消息，发生战争的时候，将军们必须制定统一的行动计划，然而这些将军当中有叛徒，叛徒希望通过影响统一行动计划的制定与传播，来破坏忠诚将军们的行动计划，因此，将军们必须有一个预定的方法协议，使所有忠诚的将军能够达成一致，而且少数几个叛徒不能够使忠诚的将军做出错误的决策。

因此，拜占庭将军问题的核心——是要寻找一个，使得将军们在一个明知有叛徒的非信任环境中，建立对战计划的共识。如何可以不带任何条件的相信彼此。

为了能够合理的解决拜占庭将军问题，我们假设每个将军都有自己的军队，每支军队都位于他们打算攻击的城市周围的不同位置，这些将军需要就攻击或者撤退达成一致，只要所有将军达成共识，无论是进攻还是撤退都无关紧要。因此我们可以考虑以下几个条件：

每个将军必须就攻击还是撤退进行投票
一旦投票则不可更改
所有将军都必须就同样的决定，形成统一意见，并协调执行。
他们只能通过情报员发送的信息进行交流。
拜占庭将军问题所面临的核心挑战便是信息可能以某种方式被延误，破坏或丢失。此外即使消息传递成功。一个或多个将军也可能因为各种原因选择发送欺诈性消息，以混淆其他将军，导致行动失败。

如果我们将拜占庭将军问题对应到区块链网络中上，则每个将军代表一个网络节点，需要就系统的当前状态达成共识。这意味着分布式网络中的大多数参与者必须同意并执行相同的操作，以避免失败。 其中有运行正常的服务器，类似于忠诚的拜占庭将军，还有故障的服务器，有破坏者的服务器，类似于叛变的拜占庭将军。

## 二、拜占庭将军问题解决方案

对拜占庭问题的深入研究，可以得出一个结论：如果叛徒的数量大于或等于1/3，拜占庭问题不可解。

解释过程可以用一个副官模型来解释：

假设只有3个人，A、B、C，三人中如果其中一个是叛徒。当A发出进攻命令时，B如果是叛徒，他可能告诉C，他收到的是“撤退”的命令。这时C收到一个“进攻”，一个“撤退“，于是C被信息迷惑，而无所适从。

如果A是叛徒。他告诉B“进攻”，告诉C“撤退”。当C告诉B，他收到“撤退”命令时，B由于收到了司令“进攻”的命令，而无法与C保持一致。

正由于上述原因，在只有三个角色的系统中，只要有一个是叛徒，即叛徒数等于1/3，拜占庭问题便不可解。当然，只要叛徒数小于1/3，问题还是可解的。

科学家们提出了口头信息方案和书面协议两个方案。

### 1.解决方案一：用口头信息

口头信息即使将军们派人用口信传达消息，口头传达消息的实际含义指的是：

每个被发送的消息都能够被正确投递
信息接受者知道消息是谁发的
沉默（不发消息）可以被检测
口头协议的算法很简单，假设共有1-10号十个节点，如果其中一个节点，比如1号节点发布消息出去，2-10号节点都接受到1号节点的消息，然后2-10号节点也分别转告给其他的节点，每个节点都是信息的转达者，一轮下来，每个节点手上都会有10个信息（进攻或者撤退），有叛徒的话，那信息可能有进攻或者不进攻的不一致消息。每个人相当于手里有一本消息的账本，该怎么决策呢？如果有一半以上的人说进攻，那么采取进攻行动就是能成功的，所以这时即便有叛徒，只要听大部分人的，少数服从多数来行动即是有利的。

这种口头协议的算法也存在明显的缺点：口头协议并不会告知消息的上一个来源是谁，也就是消息不可追根溯源，出现信息不一致也很难找到叛徒在哪。

### 2.解决方案二：用书面协议

可以假设10个将军，每个将军都可以派人向其他将军派信，比如一起约定 “某天早上六点，大家一起进攻某个城市，同意就签个字”。收到信的将军如果同意的话，就可以在原信上签名盖章。

书面协议相比口头协议，实际说的是在这个多人的将军模型中加了了个隐含条件：

 * 将军们能够使用签名技术，签名不可伪造，一旦篡改即可发现
 * 同时任何人都可以验证签名的可靠性。
 * 书面协议相比口头协议，所有的消息都是有记录的，解决了追根溯源的问题

 但在现实中仍然可能面临各种问题：

* 中世纪的将军之间沟通只能靠信使骑马，将军们互不信任，也不可能亲自聚在一起开会，物理距离导致信息传输延迟。
* 真正可信的签名体系难以实现。签名造假的问题也没法避免。
* 签名消息记录的保存难以摆脱中心化的机构。

另外，倘若每个将军都各自向其他9个将军派出信使，在这个网络即需要90次的传输才能完成一轮信息交流，但是每个将军可能回馈不同的进攻时间，在这种异步通信的条件下，要能协商一致是个大问题。

也就是如果能够依赖中心化可信的机构，也许能通过多方的签名记录整合在一起，更容易地实现9个将军的意见统一，但这是个伪假设，因为前提是这个网络就是互不信任的。

这就是一个由互不信任的各个将军所构成的分布式网络，要获得最大的利益，又必须一起努力才能完成，如何达成一致的共识，变成了一个难题。

## 三、拜占庭容错算法

拜占庭容错（Byzantine Fault Tolerance, BFT）算法是由拜占庭将军问题衍生出来的共识算法。我们可以将共识算法定义为一种机制，共识算法的核心是在正常的节点之间形成网络状态的共识。拜占庭容错算法是一种能够抵抗由拜占庭将军问题所导致的一系列故障的系统属性。也就是说，即使某些节点之间沟通失败或者存在恶意行为。拜占庭容错系统也能够继续运行。有很多种方式，可以创建一个拜占庭容错区块链，而这关系到不同类型的共识算法。

拜占庭容错共识算法有3种版本，每种版本都具有各自的优缺点。这些版本分别是：

* 实用拜占庭容错（PBFT，Practical Byzantine Fault Tolerance）
* 联邦拜占庭协议（FBA，Federated Byzantine Agreement）
* 授权拜占庭容错算法（dBFT，Delegated Byzantine Fault Tolerance）

### 1.实用拜占庭容错（PBFT，Practical Byzantine Fault Tolerance

优点：高速、可扩展

缺点：通常用于私有网络和许可网络

采用者：Hyperledger Fabric、Ripple

实用拜占庭容错PBFT是首个解决拜占庭将军问题的方案，当前已被 Hyperledger Fabric 采用。PBFT 使用了较少（少于 20 个，之后会稍有增加）的预选定将军数，因此运行非常高效。它的优点是高交易通量和吞吐量，但是不足之处在于是中心化的，并用于许可网络。使用拜占庭容错机制是一种采用“许可投票、少数服从多数”来选举领导者并进行记账的共识机制，该共识机制允许拜占庭容错，允许强监督节点参与，具备权限分级能力，性能更高，耗能更低，而且每轮记账都会由全网节点共同选举领导者，允许33%的节点作恶，容错率为33%。换句话说，PBFT假设区块链上总的节点数是3f+1个，那么网络中可以容忍整个网络中最多f个节点出现拜占庭错误而不影响正确的共识。


### 2.联邦拜占庭协议（FBA，Federated Byzantine Agreement）

优点：吞吐量、低交易开销和网络扩展性

采用者：Stellar

另一类拜占庭将军问题的解决方案是 FBA，已被 Stellar 等代币使用。FBA 的通用理念是每个拜占庭将军负责自身的链、消息一旦到来，通过排序建立事实。在 Stellar 中，任何人都可以成为验证者，需要用户选择去相信哪个验证者

实用拜占庭容错（PBFT）和联邦拜占庭协议（FBA）这2种共识算法的区别在于：PBFT是单邦制（可以理解为一个国家就是由一个邦组成），FBA是联邦制（可以理解为一个国家由多个联邦组成）。另外，PBFT的节点是预先选定或通过授权的。FBA是一个完全可以自由加入成为节点或退出节点的共识方式，每个邦内的白名单中节点（有记账和出块权的节点）通过投票选举产生（需要至少获得该联邦2/3节点的的同意）。因此，FBA比PBFT的去中心化程度更高，但是牺牲了一定的性能。

### 3. 授权拜占庭容错算法（dBFT，Delegated Byzantine Fault Tolerance）

优点：快速；可扩展

缺点：每个人都争相成为根链。其中可能存在多个根链

采用者：Neo

授权拜占庭容错算法，简称 dBFT，是一种支持通过代理投票实现大规模参与共识的拜占庭容错共识算法。在国产第一条公链小蚁Neo中，令牌持有者可以通过投票选取其支持的 bookkeeper。之后，选定的 bookkeeper 组采用 BFT 算法达成共识，并生成新区块。Neo 网络中的投票是实时的，而非因人而异的。

dBFT 可为具有个共识节点的共识系统提供f=n−13容错。这种容错也涵盖了安全性和可用性、不受将军和拜占庭错误影响，并且适合任何网络环境。dBFT 具有很好的最终性（finality），这意味着一旦最终确认，区块将不可分叉，交易将不可再撤销或是回滚。

Neo 的 dBFT 机制生成一个区块需 15 到 20 秒钟。交易吞吐量测定约为 1000 TPS。这对于公共区块链而言，这是很好的性能。通过一定优化，dBFT 具有达到一万 TPSS 的潜力，这样就可支持大规模的商业应用。

dBFT 中加入了数字身份技术，这意味着 bookkeeper 可以是真实的个人，也可以是某些机构。因此，dBFT 根据存在于其本身之中的司法判决，可以冻结、撤销、继承、检索和拥有代币兑换权。它有利于实现合规金融资产在 Neo 网络中的注册。Neo 网络从设计上，就是在必要时为此提供支持。

同样是为了解决拜占庭将军问题，授权拜占庭容错机制，是一种在Neo区块链内部实现的保证容错的共识算法。

在这个机制当中，存在两个参与者，一个是专业记账的“记账节点”，一个是系统当中的普通用户。

普通用户基于持有权益的比例来投票决定记账节点，当需要通过一项共识时，在这些记账节点中随机推选出一名发言人拟定方案，然后由其他记账节点根据拜占庭容错算法，即少数服从多数的原则进行表态，如果超过66%的节点表示同意发言人方案，则共识达成；否则，重新推选发言人，重复投票过程。

所以说，dBFT机制实际使用了一种迭代共识的方法来保证系统达成一致决定。然而，这种机制的缺点在于，当系统中有超过三分之一的记账节点停止工作时，整个区块链网络将无法提供正常的服务；当超过三分之一的节点联合作恶时，区块链将有可能发生分叉。


> 哈尔滨工程大学计算机学院2021年区块链技术课程

> 郝沂铜 王博韬 孟宪韬